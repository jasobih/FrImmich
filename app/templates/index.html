<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Immich-Frigate Face Sync</title>
    <link rel="stylesheet" href="{{ url_for('static', filename='style.css') }}">
</head>
<body>
    <div class="container">
        <header>
            <h1>Immich-Frigate Face Sync</h1>
            <p class="version">Version: 0.1.0</p>
        </header>

        <section class="config-display card">
            <h2>Configuration</h2>
            <p><b>Immich URL:</b> <code>{{ config.IMMICH_API_URL }}</code></p>
            <p><b>Frigate Faces Directory:</b> <code>{{ config.FRIGATE_FACES_DIR }}</code></p>
            <p><b>Scheduled Sync:</b> 
                {% if config.SYNC_SCHEDULE_INTERVAL_HOURS > 0 %}
                    Every {{ config.SYNC_SCHEDULE_INTERVAL_HOURS }} hours
                {% else %}
                    Disabled
                {% endif %}
            </p>
        </section>

        <section class="people-selection card">
            <h2>Select People to Sync</h2>
            <div id="peopleList" class="people-list">
                <p>Loading people from Immich...</p>
            </div>
            <button id="selectAllBtn" class="select-btn">Select All</button>
            <button id="deselectAllBtn" class="select-btn">Deselect All</button>
        </section>

        <section class="actions">
            <button id="syncBtn">Sync Now</button>
        </section>

        <section class="status card">
            <h2>Live Status</h2>
            <div id="statusArea" class="status-message">Idle.</div>
            <div class="progress-container">
                <div class="progress-bar" id="progressBar"></div>
            </div>
            <p id="progressText" class="progress-text"></p>
        </section>

        <section class="summary card">
            <h2>Last Sync Summary</h2>
            <pre id="summaryArea" class="summary-content"><code>Never.</code></pre>
        </section>

        <section class="logs card">
            <h2>Logs</h2>
            <pre id="logArea" class="log-content"><code></code></pre>
        </section>
    </div>

    <script>
        document.addEventListener('DOMContentLoaded', () => {
            const syncBtn = document.getElementById('syncBtn');
            const statusArea = document.getElementById('statusArea');
            const summaryArea = document.getElementById('summaryArea').firstElementChild;
            const logArea = document.getElementById('logArea').firstElementChild;
            const progressBar = document.getElementById('progressBar');
            const progressText = document.getElementById('progressText');
            const peopleList = document.getElementById('peopleList');
            const selectAllBtn = document.getElementById('selectAllBtn');
            const deselectAllBtn = document.getElementById('deselectAllBtn');

            let allPeople = []; // To store the fetched people data

            // Function to fetch and display people
            const fetchPeople = () => {
                fetch('/api/people')
                    .then(res => res.json())
                    .then(data => {
                        if (data.error) {
                            peopleList.innerHTML = `<p class="error-message">Error loading people: ${data.error}</p>`;
                            return;
                        }
                        allPeople = data.sort((a, b) => a.name.localeCompare(b.name)); // Sort alphabetically
                        peopleList.innerHTML = ''; // Clear loading message
                        allPeople.forEach(person => {
                            const div = document.createElement('div');
                            div.className = 'person-item';
                            div.innerHTML = `
                                <input type="checkbox" id="person-${person.id}" value="${person.id}">
                                <label for="person-${person.id}">${person.name}</label>
                            `;
                            peopleList.appendChild(div);
                        });
                    })
                    .catch(error => {
                        peopleList.innerHTML = `<p class="error-message">Network error fetching people: ${error}</p>`;
                    });
            };

            // Initial fetch of people
            fetchPeople();

            selectAllBtn.addEventListener('click', () => {
                peopleList.querySelectorAll('input[type="checkbox"]').forEach(checkbox => {
                    checkbox.checked = true;
                });
            });

            deselectAllBtn.addEventListener('click', () => {
                peopleList.querySelectorAll('input[type="checkbox"]').forEach(checkbox => {
                    checkbox.checked = false;
                });
            });

            syncBtn.addEventListener('click', () => {
                const selectedPersonIds = Array.from(peopleList.querySelectorAll('input[type="checkbox"]:checked'))
                                            .map(checkbox => checkbox.value);
                
                if (selectedPersonIds.length === 0) {
                    alert('Please select at least one person to sync.');
                    return;
                }

                syncBtn.disabled = true;
                syncBtn.textContent = 'Starting...';
                fetch('/trigger_sync', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json'
                    },
                    body: JSON.stringify({ person_ids: selectedPersonIds })
                });
            });

            setInterval(() => {
                fetch('/status')
                    .then(res => res.json())
                    .then(data => {
                        syncBtn.disabled = data.in_progress;
                        syncBtn.textContent = data.in_progress ? 'Sync in Progress...' : 'Sync Now';
                        statusArea.textContent = data.status_message;
                        
                        if (Object.keys(data.last_sync_summary).length > 0) {
                            summaryArea.textContent = JSON.stringify(data.last_sync_summary, null, 2);
                        } else {
                            summaryArea.textContent = 'Never.';
                        }

                        logArea.textContent = data.logs.join('\n');
                        // Auto-scroll logs to the bottom
                        logArea.parentElement.scrollTop = logArea.parentElement.scrollHeight;

                        // Update progress bar
                        if (data.in_progress && data.total_faces_to_process > 0) {
                            const percent = (data.processed_faces_count / data.total_faces_to_process) * 100;
                            progressBar.style.width = `${percent}%`;
                            progressText.textContent = `Processing ${data.current_person}: ${data.processed_faces_count} of ${data.total_faces_to_process} faces (${percent.toFixed(1)}%)`;
                            progressBar.style.backgroundColor = '#2ecc71'; // Green when in progress
                        } else if (data.in_progress) {
                            progressBar.style.width = '100%';
                            progressBar.style.backgroundColor = '#f39c12'; // Orange for indeterminate
                            progressText.textContent = 'Initializing sync...';
                        } else {
                            progressBar.style.width = '0%';
                            progressBar.style.backgroundColor = '#ccc'; // Gray when idle
                            progressText.textContent = '';
                        }
                    });
            }, 2000); // Poll every 2 seconds
        });
    </script>
</body>
</html>
